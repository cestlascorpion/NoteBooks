
# RTSP&RTP/RTCP 学习笔记

## RTSP

**实时流协议** Real Time Streaming Protocol

RTSP 的请求主要有`DESCRIBE`、`SETUP`、`PLAY`、`PAUSE`、`TEARDOWN`、`OPTIONS`等，顾名思义可以知道起对话和控制作用，RTSP 的对话过程中`SETUP`可以确定 RTP/RTCP 使用的端口，`PLAY/PAUSE/TEARDOWN`可以开始或者停止 RTP 的发送等。

作为一个应用层协议，RTSP 提供了一个可供扩展的框架，使得实时流媒体数据的受控点播成为可能。总的来说，RTSP是一个流媒体表示协议，主要用来 **控制** 具有 **实时特性** 的数据发送，但它本身并 **不传输数据**，而是必须依赖于下层传输协议所提供的某些服务。RTSP 可以对流媒体提供诸如播放、暂停、快进等操作，它负责定义具体的控制消息、操作方法、状态码等，此外还描述了与 RTP 间的交互操作（RFC2326）。RTSP 在制定时较多地参考了 HTTP/1.1 协议，甚至许多描述与 HTTP/1.1 完全相同。由 RTSP 控制的媒体流集合可以用表示描述（Presentation Description）来定义，所谓表示是指流媒体服务器提供给客户机的一个或者多个媒体流的集合，而表示描述则包含了一个表示中各个媒体流的相关信息，如数据编码/解码算法、网络地址、媒体流的内容等。虽然 RTSP 服务器同样也使用标识符来区别每一流连接会话（Session），但 RTSP 连接并没有被绑定到传输层连接（如 TCP 等），也就是说在整个 RTSP 连接期间，RTSP 用户可打开或者关闭多个对 RTSP 服务器的可靠传输连接以发出 RTSP 请求。此外，RTSP 连接也可以基于面向无连接的传输协议（如 UDP 等）。

## RTP

**实时传输协议** Real-time Transport Protocol

RTP/RTCP 是实际传输数据的协议，RTP 传输音频/视频数据，如果是`PLAY`，Server 发送到 Client 端，如果是`RECORD`，可以由 Client 发送到 Server。整个 RTP 协议由两个密切相关的部分组成：RTP 数据协议和 RTP 控制协议（即 RTCP）。RTP 数据协议负责对流媒体数据进行封包并实现媒体流的实时传输，每一个 RTP 数据报都由头部（Header）和负载（Payload）两个部分组成，其中头部前12个字节的含义是固定的，而负载则可以是音频或者视频数据。RTP，实时传输协议，顾名思义它是用来提供实时传输的，因而可以看成是传输层的一个子层。下图给出了流媒体应用中的一个典型的协议体系结构。

![RTXP](Resource/RTxP.png)

从图中可以看出，RTP 被划分在传输层，它建立在 UDP 上。同 UDP 协议一样，为了实现其实时传输功能，RTP 也有固定的封装式。RTP 用来为端到端的实时传输提供时间信息和流同步，但并不保证服务质量。服务质量由 RTCP 来提供。

当应用程序建立一个 RTP 会话时，应用程序将确定一对目的传输地址。目的传输地址由一个网络地址和一对端口组成，有两个端口：一个给 RTP 包，一个给 RTCP 包，使得 RTP/RTCP 数据能够正确发送。RTP 数据发向偶数的 UDP 端口，而对应的控制信号RTCP 数据发向相邻的奇数 UDP 端口（偶数的 UDP 端口＋1），这样就构成一个 UDP 端口对。RTP 的发送过程如下，接收过程则相反。

>1. RTP 协议从上层接收流媒体信息码流，封装成 RTP 数据包; RTCP 从上层接收控制信息，封装成 RTCP 控制包;
>2. RTP 将 RTP 数据包发往 UDP 端口对中偶数端口；RTCP 将 RTCP 控制包发往 UDP 端口对中的奇数端口。

TCP/UDP 协议利用端口号实现多项应用同时发送和接收数据。数据通过源端口发送出去，通过目标端口接收。有的网络应用只能使用预留或注册的静态端口；而另外一些网络应用则可以使用未被注册的动态端口。因为 TCP/UDP 报头使用两个字节存放端口号，所以端口号的有效范围是从[0，65535]。动态端口的范围是从[1024，65535]。　　

## RTCP

**实时传输控制协议** RTP Control Protocol

RTP/RTCP 是实际传输数据的协议，RTCP 包括 Sender Report 和 Receiver Report，用来 **进行音频/视频的同步以及其他用途**，是一种 **控制协议**。RTCP 的主要功能是服务质量的监视与反馈、媒体间的同步，以及多播组中成员的标识。在 RTP 会话期间，各参与者周期性地传送 RTCP 包。RTCP 包中含有已发送的数据包的数量、丢失的数据包的数量等统计资料，因此各参与者可以利用这些信息动态地改变传输速率，甚至改变有效载荷类型。RTP/RTCP 配合使用，以有效的反馈和最小的开销使传输效率最佳化，因而特别适合传送网上的实时数据。RTCP 也是用 UDP 来传送的，但 RTCP 封装的仅仅是一些控制信息，因而分组很短，可以将多个 RTCP 分组封装在一个 UDP 包中。

## MPEG-TS

`ES`: Elementary Streams （原始流）是直接从编码器出来的数据流，可以是编码过的视频数据流（H.264，MJPEG 等），音频数据流（AAC），或其他编码数据流的统称。`ES`流经过`PES`打包器之后，被转换成`PES`包。`ES`是只包含一种内容的数据流，如 **只含视频或只含音频** ，打包之后的`PES`也是只含一种性质的`ES`。每个`ES`都由若干个存取单元（AU）组成，每个视频`AU`或音频`AU`都是由头部和编码数据两部分组成，1个`AU`相当于编码的1幅视频图像或1个音频帧。也可以说，每个`AU`实际上是编码数据流的显示单元，即相当于解码的1幅视频图像或1个音频帧的取样。

`PES`: Packetized Elementary Streams （分组的ES），`ES`形成的分组称为`PES`分组，是用来传递`ES`的一种数据结构。`PES`流是`ES`流经过`PES`打包器处理后形成的数据流，在这个过程中完成了将`ES`流分组、打包、加入包头信息等操作（对`ES`流的 **第一次打包**）。`PES`流的基本单位是`PES`包。`PES`包由`header`和`payload`组成。

`PTS/DTS`: PresentationTime Stamp（显示时间标记）表示显示单元出现在系统目标解码器（H.264、MJPEG 等）的时间。DTS（Decoding Time Stamp，解码时间标记）表示将存取单元全部字节从解码缓存器移走的时间。`PTS/DTS`是打在`PES`包的包头里面的，这两个参数是解决音视频同步显示，防止解码器输入缓存上溢或下溢的关键。每一个`I`（关键帧）、`P`（预测帧）、`B`（双向预测帧）帧的包头都有一个`PTS`和`DTS`，但`PTS`与`DTS`对于`B`帧不一样，无需标出`B`帧的`DTS`，对于`I`帧和`P`帧，显示前一定要存储于视频解码器的重新排序缓存器中，经过延迟（重新排序）后再显示，所以一定要分别标明`PTS`和`DTS`。

`PS`: Program Stream （节目流）由`PS`包组成，而一个`PS`包又由若干个`PES`包组成（到这里，`ES`经过了 **两层的封装**)。`PS`包的包头中包含了 **同步信息与时钟恢复信息**。一个`PS`包最多可包含具有同一时钟基准的16个视频`PES`包和32个音频`PES`包。

`TS`: Transport Stream （传输流）由定长的`TS`包组成（188字节），而`TS`包是对`PES`包的一个重新封装（到这里，`ES`也经过了 **两层的封装**）。`PES`包的包头信息依然存在于`TS`包中。`TS`流与`PS`流的区别在于`TS` **流的包结构是固定长度的**，而`PS` **流的包结构是可变长度的**。`PS`包由于长度是变化的，一旦丢失某一`PS`包的同步信息，接收机就会进入失步状态，从而导致严重的信息丢失事件。而`TS`码流由于采用了固定长度的包结构，当传输误码破坏了某一`TS`包的同步信息时，接收机可在固定的位置检测它后面包中的同步信息，从而恢复同步，避免了信息丢失。因此在信道环境较为恶劣、传输误码较高时一般采用`TS`码流，而在信环境较好、传输误码较低时一般采用`PS`码流。

### `TS`单一码流/混合码流

单一性：`TS`流的基本组成单位是长度为188字节的`TS`包。
混合性：`TS`流由多种数据组合而成，一个`TS`包中的数据可以是 **视频数据**，**音频数据**，**填充数据**，**PSI/SI 表格数据** 等（唯一的PID对应）。

### PS/TS流打包流程

>1. A/D转换后，通过`MPEG-2`压缩编码得到的`ES`基本流。这个数据流很大，并且只是`I`，`P`，`B`的这些视频帧或音频取样信息。
>2. 通过`PES`打包器，**打包并在每个帧中插入 `PTS/DTS` 标志，变成 `PES`**。原来是流的格式，现在成了 **数据包的分割形式**。
>3. `PES`根据需要打包成`PS`或`TS`包进行存储（DVD）或传输(DVB)。因每路音/视频只包含一路的编码数据流，所以每路`PES`也只包含相应的数据流。

![MPEG_TS](Resource/MPEG-TS.jpg)

![RTPpacket](Resource/RTPinNetwork.png)

## TCP/UDP 包大小的限制

TCP/IP协议，涉及到四层：链路层，网络层，传输层，应用层。不同的协议层对数据包有不同的称谓，在传输层叫做段(segment)，在网络层叫做数据报(datagram)，在链路层叫做帧(frame)。数据封装成帧后发到传输介质上，到达目的主机后每层协议再剥掉相应的首部，最后将应用层数据交给应用程序处理。它们的关系是 (以太网)数据帧｛ IP 包｛ TCP/UDP 包｛ Data ｝｝｝。

![Network](Resource/NetworkPacket.png)

由于以太网 EthernetII 最大的数据帧是 1518 Bytes。除去以太网帧的帧头（DMAC 目的 MAC 地址 6 Bytes + SMAC 源 MAC 地址 6Bytes + Type 域 2 Bytes + 帧尾 CRC 校验部分 4 Bytes 那么剩下承载上层协议的地方也就是 Data 域最大就只能有 1500 Bytes这个值我们就把它称之为 MTU。

在链路层，由以太网的物理特性决定了数据帧的长度为[(46 ＋ 18)，(1500 ＋ 18)]，其中的18是数据帧的头和尾，也就是说数据帧的内容最大为1500(不包括帧头和帧尾)，即 MTU(Maximum Transmission Unit) = 1500。

在网络层，因为 IP 包的首部要占用20字节，所以这的 MTU 为 1500 － 20 ＝ 1480。在传输层，对于 UDP 包的首部要占用8字节，所以这的 MTU 为 1480 － 8 ＝ 1472。同理 TCP 包的大小就应该是 1500 - IP头(20) - TCP头(20) = 1460 (Bytes)。

所以，在应用层 Data 最大长度为1472。当 UDP 包中的数据多于 MTU(1472) 时，发送方的 IP 层需要分片 fragmentation 进行传输，而在接收方 IP 层则需要进行数据报重组，由于 UDP 是不可靠的传输协议，如果分片丢失导致重组失败，将导致 UDP 数据包被丢弃。从上面的分析来看，在普通的局域网环境下，UDP 的数据最大为1472字节最好(避免分片重组)。但在网络编程中，Internet 中的路由器可能有设置成不同的值(小于默认值)，Internet上 的标准 MTU 值为576，所以 Internet 的 UDP 编程时数据长度最好在 576 － 20 － 8 ＝ 548字节以内。

UDP数据报的长度是指包括报头和数据部分在内的总字节数，其中报头长度固定，数据部分可变。数据报的最大长度根据操作环境的不同而各异。从理论上说，包含报头在内的数据报的最大长度为65535字节(64K)。

我们在用 Socket 编程时，UDP 协议要求包小于64K。TCP 没有限定，TCP 包头中就没有“包长度”字段，而完全依靠 IP 层去处理分帧。这就是为什么 TCP 常常被称作一种“流协议”的原因，开发者在使用 TCP 服务的时候，不必去关心数据包的大小，只需讲`SOCKET`看作一条数据流的入口，往里面放数据就是了，TCP 协议本身会进行拥塞/流量控制。

不过 Internet(非局域网)上的标准 MTU 值为576字节，所以建议在进行 Internet 的 UDP 编程时，最好将 UDP 的数据长度控制在548字节 (576-8-20)以内。

## Wi-Fi Display 中的 RTSP

2012年11月中旬，Google发布了Android 4.2。虽然它和Android 4.1同属Jelly Bean系列，但却添加了很多新的功能。其中在显示部分，Android 4.2在Project Butter基础上再接再厉，新增了对Wi-Fi Display功能的支持。由此也导致整个显示架构发生了较大的变化。

Wi-Fi Display（Miracast） 是由 Wi-Fi 联盟于2012年所制定，以 Wi-Fi direct 为基础的无线显示标准。支持此标准的设备可通过无线方式分享视频画面，例如手机将影片或照片直接在电视或其他装置播放而无需受到连接线缆长度的影响。Wi-Fi Direct 标准是指允许无线网络中的设备无需通过无线路由器即可相互连接。与蓝牙技术类似，这种标准允许无线设备以点对点形式互连，而且在传输速度与传输距离方面则比蓝牙有大幅提升。

### 大体流程

Wi-Fi Display 以 session为单位来管理两个设备之间的交互的工作。主要步骤包括：

>- WFD Device Discovery（WFD设备发现）
>- WFD Service Discovery (Optional)（WFD服务发现（可选））
>- Device Selection（设备选择）
>- WFD Connection Setup（WFD连接）
>- WFD Capability Negotiation（WFD能力协商）
>- WFD Session Establishment（WFD会话建立）
>- User Input Back Channel Setup (Optional)（UIBC反向控制）
>- Link Content Protection Setup (Optional)（内容保护，即数据加密）
>- Payload Control（负载控制）
>- WFD Source and WFD Sink standby (Optional)
>- WFD Session Teardown（会话终止）

WFD设备通过wifiP2P连接后，Sink端与Source端建立TCP连接，Sink端为Client，Source端为Server。默认端口为7236，执行的协议为RTSP协议。建立连接后进行RTSP协商。步骤6，协商成功后建立会话；步骤7，UIBC通道建立，用于Sink端反向控制Source端，该步骤为可选实现； 步骤8，对与传输的内容做加密保护（HDCP），步骤9，开始音频及视频流的传输与控制；步骤10，传输过程中，设备可根据无线信号的强弱，甚至设备的电量状况来动态调整传输数据和格式。可调整的内容包括压缩率，视音频格式，分辨率等内容；步骤11，会话终止。Miracast本质就是一个基于Wi-Fi的网络应用。这个应用包括服务端和客户端。服务端和客户端必须支持RTP/RTSP等网络协议和相应的编解码技术。

### 视音频格式支持

分辨率

>- 17种 CEA格式，分辨率从 640 x 480 到 1920 x 1080，帧率从24到60
>- 29种 VESA格式，分辨率从 800 x 600 到 1920 x 1200，帧率从30到60
>- 12种 HH格式，分辨率从 640 x 360 到 960 x 540，帧率从30到60

视频

>- H.264，CBP&CHP，Level3.0～4.1

音频

>- 必选：LPCM 16bits，48kHz采样率，双声道
>- 可选：LPCM 16bits，44.1kHz采样率，双声道；Advanced Audio coding；Dolby Advanced Codec 3

下图给出了WFD涉及的技术及协议框图，基于WifiP2P网络技术，利用RTSP作为音频及视频流控制协议，涉及了流媒体的传输、控制、加密、解密、编码及解码等技术流程。

![miracast](Resource/Miracast.jpg)

下图为WFD建立链接和Cast的流程。

![miracast](Resource/MiracastRTSP01.jpg)

![miracast](Resource/MiracastRTSP02.jpg)